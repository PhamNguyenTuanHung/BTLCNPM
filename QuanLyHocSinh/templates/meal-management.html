{% extends "layout/base.html" %}

{% block title %}Quáº£n lÃ½ Ä‚n uá»‘ng Tráº» em - Hoa Mai{% endblock %}

{% block content %}

<div class="page-content-wrapper">


    <div class="control-panel">
        <div class="control-header">
            <div>
                <h2>Quáº£n lÃ½ Bá»¯a Äƒn Tráº» em</h2>
                <p class="student-count-text">
                    Tá»•ng sá»‘ tráº» Ä‘ang theo dÃµi: <span class="count-highlight">{{ students|length }}</span>
                </p>
            </div>
        </div>

        <div class="date-picker" style="margin-top: 1rem;">
            <label for="record-date">Chá»n ngÃ y:</label>
            <input type="date" id="record-date" value="{{ today }}">
        </div>
    </div>

    <div class="content-card full-width">
        <h3>Cáº­p nháº­t cÃ¡c há»c sinh Äƒn ngÃ y {{selected_date}}</h3>
        <p class="table-note">Tick âœ” náº¿u tráº» Ä‘Ã£ Äƒn (Ã¡p dá»¥ng cho toÃ n bá»™ bá»¯a Äƒn trong ngÃ y).</p>

        <div class="meal-table-wrapper">
            <table class="meal-table">
                <thead>
                <tr>
                    <th style="width:40px;">STT</th>
                    <th style="min-width:150px;">TÃªn tráº»</th>
                    <th style="width:200px;">CÃ³ Äƒn </th>
                </tr>
                </thead>
                <tbody>
                {% for student in students %}
                {% set ate_status = student.daily_status.get(today).ate_today or false %}

                <tr data-student-id="{{ student.id }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ student.name }}</td>

                    {# Checkbox duy nháº¥t cho cáº£ ngÃ y (name="ate_today") #}
                    <td class="meal-check-in text-center">
                        <input type="checkbox" class="meal-checkbox" name="ate_today"
                               {% if ate_status %}checked{% endif %}>
                    </td>

                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="save-button-wrapper">
            <button id="save-meals">LÆ°u dá»¯ liá»‡u cháº¥m cÃ´ng</button>
        </div>
    </div>
    <div class="content-card full-width" style="margin-top: 1.5rem;">
        <h3>ğŸ“ˆ Tá»•ng Káº¿t Sá»‘ NgÃ y Ä‚n ThÃ¡ng NÃ y</h3>
        <p class="table-note">Tá»•ng sá»‘ ngÃ y tráº» Ä‘Ã£ Ä‘Æ°á»£c cháº¥m cÃ´ng lÃ  "CÃ³ Äƒn" trong thÃ¡ng hiá»‡n táº¡i.</p>

        <div class="meal-table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th style="width:40px;">STT</th>
                    <th style="min-width:150px;">TÃªn tráº»</th>
                    <th style="width:150px;">Tá»•ng NgÃ y ÄÃ£ Ä‚n</th>
                    <th style="width:150px;">Chi PhÃ­ Ä‚n Uá»‘ng</th>
                </tr>
                </thead>
                <tbody>
                {% for student in students %}
                {# Giáº£ Ä‘á»‹nh: total_meals_eaten Ä‘Æ°á»£c tÃ­nh tá»« Flask #}
                {% set days_eaten = student.total_meals_eaten | default(0) %}
                {# Giáº£ Ä‘á»‹nh: student.meal_cost Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n (vÃ­ dá»¥ 25000) #}
                {% set meal_cost = student.meal_cost | default(25000) %}
                {% set total_cost = days_eaten * meal_cost %}

                <tr data-student-id="{{ student.id }}">
                    <td>{{ loop.index }}</td>
                    <td class="text-bold">{{ student.name }}</td>

                    {# Tá»•ng NgÃ y ÄÃ£ Ä‚n #}
                    <td class="text-center text-success text-bold">
                        {{ days_eaten }} ngÃ y
                    </td>

                    {# Chi PhÃ­ Ä‚n Uá»‘ng (VÃ­ dá»¥: 25,000 VND/ngÃ y) #}
                    <td class="text-right text-warning text-bold">
                        {{ "{:,.0f}".format(total_cost) }} Ä‘
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>


    </div>

    <script>
        // HÃ m Ä‘á»ƒ láº¥y ngÃ y Ä‘Æ°á»£c chá»n tá»« input date
        function getSelectedDate() {
            return document.getElementById('record-date').value;
        }

        // Sá»± kiá»‡n lÆ°u dá»¯ liá»‡u bá»¯a Äƒn
        const saveBtn = document.getElementById('save-meals');
        saveBtn.addEventListener('click', () => {
            const date = getSelectedDate();
            const data = [];

            document.querySelectorAll('tr[data-student-id]').forEach(tr => {
                const studentId = tr.dataset.studentId;

                // Láº¥y tráº¡ng thÃ¡i cá»§a checkbox duy nháº¥t (name="ate_today")
                const ateTodayCheckbox = tr.querySelector('.meal-checkbox[name="ate_today"]');
                const ate_today = ateTodayCheckbox ? ateTodayCheckbox.checked : false;

                // Dá»¯ liá»‡u Ä‘Æ¡n giáº£n hÃ³a cho backend
                data.push({
                    studentId: studentId,
                    date: date,
                    // Gá»­i tráº¡ng thÃ¡i cháº¥m cÃ´ng duy nháº¥t
                    ate_today: ate_today
                });
            });

            console.log('Dá»¯ liá»‡u cháº¥m cÃ´ng gá»­i lÃªn server:', data);

            // Gá»­i dá»¯ liá»‡u lÃªn server (cáº§n Ä‘iá»u chá»‰nh URL vÃ  phÆ°Æ¡ng thá»©c thá»±c táº¿)
            // fetch('/update-meal-attendance', {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(data)
            // });

            alert(`ÄÃ£ lÆ°u dá»¯ liá»‡u cháº¥m cÃ´ng bá»¯a Äƒn cho ngÃ y ${date}! Vui lÃ²ng kiá»ƒm tra console.`);
        });

        // Táº£i dá»¯ liá»‡u bá»¯a Äƒn khi ngÃ y thay Ä‘á»•i (Logic phÃ­a Frontend)
        document.getElementById('record-date').addEventListener('change', (e) => {
            const newDate = e.target.value;
            console.log(`ÄÃ£ chá»n ngÃ y má»›i: ${newDate}. Táº£i dá»¯ liá»‡u cháº¥m cÃ´ng tÆ°Æ¡ng á»©ng...`);
            // ThÃªm logic fetch dá»¯ liá»‡u cháº¥m cÃ´ng cho newDate táº¡i Ä‘Ã¢y vÃ  cáº­p nháº­t báº£ng
            // VÃ­ dá»¥: updateTableWithAttendance(newDate);
        });

    </script>

    {% endblock %}