{% extends "layout/base.html" %}

{% block title %}Qu·∫£n l√Ω H·ªçc ph√≠ & B·ªØa ƒÉn - Hoa Mai{% endblock %}

{% block content %}

<div class="page-content-wrapper">
    <div class="control-panel">
        <div class="control-header">
            <div>
                <h2>Qu·∫£n l√Ω Chi ph√≠ B·ªØa ƒÉn & H·ªçc ph√≠</h2>
                <p class="student-count-text">Th√°ng hi·ªán t·∫°i: <span class="count-highlight">Th√°ng 11/2025</span> | ƒê∆°n
                    gi√° b·ªØa ƒÉn: <span class="count-highlight">{{ base_meal_cost | default(50000)  }} VND</span></p>
            </div>
            <button id="export-fee-btn" class="btn-action-fee btn-export-invoice" style="background: linear-gradient(to right, #059669, #10B981);">
                Xu·∫•t B√°o c√°o Chi ph√≠
            </button>
        </div>
    </div>

    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-box bg-blue" style="background: linear-gradient(to right, #8B5CF6, #C084FC);">
            <div class="stat-label">H·ªçc ph√≠ c∆° b·∫£n</div>
            <div class="stat-value">3.000.000 ƒë</div>
            <div class="text-sm opacity-80 mt-1">M·ªói th√°ng</div>
        </div>
        <div class="stat-box bg-rose">
            <div class="stat-label">Ti·ªÅn ƒÉn th√™m </div>
            <div class="stat-value">50.000 ƒë</div>
            <div class="text-sm opacity-80 mt-1">M·ªói ng√†y</div>
        </div>
        <div class="stat-box bg-green">
            <div class="stat-label">T·ªïng ph√≠ d·ª± ki·∫øn</div>
            <div class="stat-value">15.000.000 ƒë</div>
            <div class="text-sm opacity-80 mt-1">Th√°ng n√†y</div>
        </div>
    </div>

    {# üìä 2. CHI TI·∫æT B·∫¢NG D·ªÆ LI·ªÜU #}
    <div class="content-card full-width">
        <h3>Chi ti·∫øt B·ªØa ƒÉn & H·ªçc ph√≠</h3>
        <div class="meal-table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n tr·∫ª</th>
                    <th>H·ªçc ph√≠ c∆° b·∫£n</th>
                    <th>B·ªØa ƒÉn & Chi ph√≠</th>
                    <th>T·ªïng c·ªông</th>
                    <th>Tr·∫°ng th√°i thanh to√°n</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                {% for record in tuition_records %}
                {# S·ª≠ d·ª•ng bi·∫øn ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n trong h√†m Flask /tuition #}
                {% set total_meal_cost = record.total_meal_cost | default(0) %}
                {% set base_fee = record.base_fee | default(3000000) %}
                {% set total_fee = record.calculated_total_fee | default(base_fee + total_meal_cost) %}
                {% set meals_eaten = record.meals_eaten_days | default(0) %}
                {% set paid_status = record.paid_status | default(false) %}

                <tr data-id="{{ record.student_id }}">
                    <td data-label="STT">{{ loop.index }}</td>
                    <td data-label="T√™n tr·∫ª">{{ record.name }}</td>
                    <td data-label="H·ªçc ph√≠ c∆° b·∫£n" class="text-bold">{{ "{:,.0f}".format(base_fee) }} ƒë</td>

                    {# G·ªòP C·ªòT: S·ªë ng√†y ƒÉn th√™m v√† Ti·ªÅn ƒÉn th√™m #}
                    <td data-label="B·ªØa ƒÉn & Chi ph√≠">
                        <div style="font-size: 0.9em; color: var(--color-text-medium);">
                            S·ªë ng√†y ƒÉn: <span class="text-bold">{{ meals_eaten }}</span>
                        </div>
                        <div class="text-warning text-bold" style="margin-top: 0.25em;">
                            {{ "{:,.0f}".format(total_meal_cost) }} ƒë
                        </div>
                    </td>

                    {# T·ªïng c·ªông #}
                    <td data-label="T·ªïng ph√≠ ph·∫£i thu (VND)" class="text-success text-bold">
                        {{ "{:,.0f}".format(total_fee) }} ƒë
                    </td>

                    {# Tr·∫°ng th√°i #}
                    <td data-label="Tr·∫°ng th√°i" class="{% if paid_status %}text-success{% else %}text-danger{% endif %}">
                        {% if paid_status %}ƒê√£ thanh to√°n{% else %}Ch∆∞a thanh to√°n{% endif %}
                    </td>

                    {# H√†nh ƒë·ªông #}
                    <td data-label="H√†nh ƒë·ªông">
                        {% if paid_status %}
                        <a href="/invoice/{{ record.student_id }}"
                           class="btn-action-fee btn-export-invoice">
                            Xu·∫•t HD
                        </a>
                        {% else %}
                        <a href="/payment/{{ record.student_id }}"
                           class="btn-action-fee btn-pay-fee">
                            N·ªôp ph√≠
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}